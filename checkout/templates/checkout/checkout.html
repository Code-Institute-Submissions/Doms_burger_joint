{% extends "base.html" %}
{% load static %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'checkout/css/checkout.css' %}">
{% endblock %}

{% block content %}
    <div class="overlay"></div>
    <div class="below-nav-container">
        <div class="checkout-form-container">

            {% if not request.user.is_authenticated %}
                <p>You are not currently logged in to your account. To be eligible for rewards, please sign in <a href="{% url 'account_login' %}?next={{request.path}}">here</a>.</p>
            {% elif reward_notification %}
                <div class="rewards-notification">
                {{ reward_notification }} 
                <button><a href="{% url 'menu' %}?category=burgers">Get free burger</a></button>
                </div>
            {% elif discount %}
                <div class="rewards-notification">Congratulations you've earned a free burger! Saving yourself £{{ discount }}.</div>
            {% endif %}

			<div class="col s12" id="spending_warning">
				{% if remaining_delivery_amount > 0 %}
				<p>You still need to spend £{{ remaining_delivery_amount|floatformat:2 }} more to be eligible to order online.</p>
				{% endif %}
			</div>

            <h1 id="collection-delivery-title">
            {% if is_collect %}Collection{% else %}Delivery{% endif %} Details
            </h1>
            <form action="{% url 'checkout' %}" method="POST" id="payment-form">
            {% csrf_token %}
                <h2 class="form-subtitle">Who wants these Burgers?</h2>
                    {% for field in form %}
                        {% if field.name == 'address_line1' %}
                            <h2 class="form-subtitle"> Where these burgers heading?</h2>
                        {% endif %}

                        {% if field.name == 'for_collection' %}
                            <input type="hidden" value="{{ field.value }}" name="{{ field.name }}">
                        {% else %}
                            <p>{{ field.label }}</p>
                            <p>{{ field }}</p>
                            <!-- Only show errors after posting form -->
                            {% if not GET %}
                                <div class="field-error" id="{{ field.name }}-error">
                                {% for error in field.errors %}
                                    <p>{{ error }}</p>
                                    {% if field.name == 'postcode' and forloop.last %}
                                        <button><a href="{% url 'checkout' %}?is_collect=True">COLLECT</a></button>
                                    {% endif %}
                                {% endfor %}
                                </div>
                            {% endif %}
                        {% endif %}

                    {% endfor %}
                <p>Payment</p>
                <div id="card-element"><!--Stripe.js injects the Card Element--></div>

                <p id="card-error" role="alert"></p>
                <input type="hidden" value="{{ client_secret }}" name="client_secret">
                {% if discount %}
                    <input type="hidden" value="{{ discount }}" name="discount">
                {% endif %}
                <p class="result-message hidden">
                    Payment succeeded
                </p>

                <button class="submit" id="place-order-btn">
                    PLACE YOUR ORDER (£{{ total|floatformat:2 }})
                </button>

            </form>
        </div>
    </div>
    <div id="loading-overlay">
        <div class="loading-animation">
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
        
        
{% endblock %}

{% block postloadjs %}
    {{ block.super }}
    {{ stripe_public_key|json_script:"id_stripe_public_key" }}
    {{ client_secret|json_script:"id_client_secret" }}

    <script src="{% static 'checkout/js/stripe_element.js' %}"></script>
{% endblock %}